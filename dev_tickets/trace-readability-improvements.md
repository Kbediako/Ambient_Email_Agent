# Ticket: Improve LangSmith Trace Readability

## Overview
LangSmith traces for the Gmail HITL + memory workflow remain difficult to scan. Runs surface raw email JSON in the input column and a lowercase `ai:` summary line in the output column, making it hard for reviewers to understand a case without expanding nested messages. Our current wiring follows default tracing behaviour, but it skips a few LangGraph best practices for metadata and summary presentation.

## Proposed Work
- **Tracing helpers**: Introduce `email_assistant/tracing.py` to expose shared `slugify_for_traces(...)` and `truncate_markdown(...)` utilities. Copy the inline slugify helper from `tests/conftest.py:33-55` verbatim so pytest project names remain unchanged, then update `tests/conftest.py` (and any other prior users) to import the shared helper so we only maintain one implementation. The truncation helper should cap markdown produced by `format_gmail_markdown(...)` to ~4096 characters (including the trailing `…`), trimming on a Unicode-aware whitespace boundary (use `re` from the stdlib) and appending that literal ellipsis when shortened. Accept `None`/empty input and return `""`.
- **Config metadata & naming**: Before `email_assistant.invoke`, enrich the LangGraph `config` with `run_name`, `tags`, and metadata via the shared helper. Run names must use the agent module name (`email_assistant_hitl_memory_gmail`, etc.) as a fixed prefix combined with the slugified case identifier (prefer the dataset `email_name`; fall back to subject, then sender, and finally the first eight hex characters of `str(config["configurable"]["thread_id"])` when both subject and sender are empty). Apply a 32-character cap to the case slug and sanitize with the shared helper (ASCII-only: lowercase alphanumerics, non-ASCII stripped, all other chars collapsed to `-`). Tags should mirror the launcher channel: `["pytest", agent_module, case_slug]` in tests; `scripts/run_real_outputs.py` should emit `["cli", agent_module, case_slug]`; reminder evaluation should use `["cli", agent_module, case_slug_from_filename]`; future non-interactive batch runners can adopt `["script", agent_module, case_slug]`; Studio launches should prefer `["studio", agent_module, case_slug]` (note: a lightweight Studio adapter will be required once we wire up Studio triggering). Metadata should include `{"dataset_case": email_name or None, "email_subject": subject or None, "email_sender": sender or None, "thread_uuid_prefix": thread_uuid[:8] or None}`, normalising blanks to `None` so LangSmith filters stay useful.
- **Runtime coverage**: Mirror the same config enrichment in non-pytest launchers (`scripts/run_real_outputs.py`, `scripts/run_reminder_evaluation.py`, `src/email_assistant/eval/evaluate_triage.py`). Each entrypoint that loops over emails must clone the base config inside the loop so every run gets a fresh thread id, run name, tags, and metadata derived from the helper; avoid reusing a single thread config across examples. Reminder evaluation should derive its `case_slug` from the JSON filename (e.g., `01_create_reminder.txt` → `create_reminder`). The triage evaluator should generate a fresh UUID-backed config for every dataset row because LangSmith experiments do not inject their own thread IDs.
- **Readable inputs**: When calling `_safe_log_inputs`, keep the existing minimal dict but also add an `email_markdown` snapshot generated via `format_gmail_markdown(...)`. Pass the markdown through the shared truncation helper before logging to LangSmith. The helper must accept `None`/empty values and return `""` so logging remains a no-op when inputs are missing. Preserve the original dict structure alongside the new field, and note in comments that `format_email_markdown` is the future fallback if new providers land.
- **Summary via assistant_reply**: Update `mark_as_read_node` in `email_assistant_hitl_memory_gmail.py` to stop appending a synthetic `AIMessage`. Emit the final summary solely through the structured `assistant_reply` field while continuing to populate `tool_trace` and `email_markdown`.
- **Documentation**: Extend `README_LOCAL.md` with a “LangSmith Tracing” subsection that links to LangGraph’s “Enable LangSmith Tracing” guide, describes the shared helper module (including the tests fixture import), details the run-name/tag convention (launcher-specific tag prefixes plus the Studio adapter note), reiterates the 4 KB markdown guard with the Unicode-aware whitespace trim, and calls out that non-pytest launchers must clone configs per email.

## Acceptance Criteria
- New LangSmith runs (manual or pytest-driven) display the configured run name (module prefix + sanitized case slug), tags, and metadata, exposing dataset/subject/sender/thread UUID details per the shared fallback order, and each email processed in a loop produces a unique run config.
- Reminder evaluation and triage experiments show the normalized run name/tag/metadata convention with unique configs per email (slug from dataset name or filename, UUID-derived thread prefix).
- The Input column renders the formatted markdown email context capped at ~4 KB via the shared truncation helper; raw dicts are no longer exposed by default.
- The Output column shows the summary text without an `ai:` prefix, and the existing automated suite (`pytest tests/test_response.py --agent-module=email_assistant_hitl_memory_gmail -k tool_calls`) still passes.
- The shared tracing helper is consumed by both tests (e.g., `tests/conftest.py`) and runtime logging paths for slugification and markdown truncation so Studio, pytest, and scripts produce consistent traces.
- Repository documentation reflects the tracing best practices, the Gmail-specific assumptions, the helper module, the assistant-reply-only summary approach, and guidance for non-pytest launchers to adopt per-email metadata enrichment.

## References
- Team guidance on run naming/tags and metadata fallbacks (internal notes, June 2025).
- Relevant code: `tests/agent_test_utils.py:99-149`, `tests/test_response.py:60-140`, `tests/conftest.py:33-55`, `scripts/run_real_outputs.py:70-140`, `scripts/run_reminder_evaluation.py:60-104`, `src/email_assistant/eval/evaluate_triage.py:1-140`, `src/email_assistant/email_assistant_hitl_memory_gmail.py:1180-1232`.
- New helper location: `src/email_assistant/tracing.py` (to be introduced).
- LangGraph docs: “Enable LangSmith Tracing” how-to (`/langchain-ai/langgraph` → tracing topic).
